<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì—ë¸Œë¼ì„ ìŠ¤í„°ë””ì¹´í˜ - ì§ì˜ì  ë¬¸ì˜</title>
  <meta name="description" content="ì—ë¸Œë¼ì„ ìŠ¤í„°ë””ì¹´í˜ ì§ì˜ì  ë¬¸ì˜ ë° ì˜ˆì•½ ì‹œìŠ¤í…œ" />
  <meta name="referrer" content="same-origin" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <!-- NOTE: ìš´ì˜ì—ì„  CSPë¥¼ ì„œë²„ í—¤ë”ë¡œ ì„¤ì • ê¶Œì¥ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    details > summary { cursor: pointer; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
  <div class="max-w-2xl mx-auto">
    <!-- í—¤ë” -->
    <header class="bg-white rounded-t-2xl shadow-lg p-6 mt-8">
      <h1 class="text-3xl font-bold text-center text-indigo-900">ì—ë¸Œë¼ì„ ìŠ¤í„°ë””ì¹´í˜</h1>
      <p class="text-center text-gray-600 mt-2">ì§ì˜ì  ë¬¸ì˜ ì‹œìŠ¤í…œ</p>
    </header>

    <!-- ì§€ì  ì„ íƒ -->
    <section id="page-branch" class="bg-white rounded-b-2xl shadow-lg p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">ì§ì˜ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”</h2>
      <div class="space-y-3" role="list">
        <button onclick="app.selectBranch('gyeyang','ì¸ì²œê³„ì–‘ë³¸ì ','ğŸ¢')" class="branch-btn" role="listitem">
          <span class="text-lg font-medium">ì¸ì²œê³„ì–‘ë³¸ì </span><span class="text-2xl" aria-hidden="true">ğŸ¢</span>
        </button>
        <button onclick="app.selectBranch('bakchon','ì¸ì²œë°•ì´Œì—­ì ','ğŸš‡')" class="branch-btn" role="listitem">
          <span class="text-lg font-medium">ì¸ì²œë°•ì´Œì—­ì </span><span class="text-2xl" aria-hidden="true">ğŸš‡</span>
        </button>
        <button onclick="app.selectBranch('bupyeong','ë¶€í‰ì‚¼ì‚°ì ','ğŸ™ï¸')" class="branch-btn" role="listitem">
          <span class="text-lg font-medium">ë¶€í‰ì‚¼ì‚°ì </span><span class="text-2xl" aria-hidden="true">ğŸ™ï¸</span>
        </button>
        <button onclick="app.selectBranch('sangdong','ë¶€ì²œìƒë™ì ','ğŸª')" class="branch-btn" role="listitem">
          <span class="text-lg font-medium">ë¶€ì²œìƒë™ì </span><span class="text-2xl" aria-hidden="true">ğŸª</span>
        </button>
        <button onclick="app.selectBranch('sinjung','ë¶€ì²œì‹ ì¤‘ë™ì ','ğŸ¬')" class="branch-btn" role="listitem">
          <span class="text-lg font-medium">ë¶€ì²œì‹ ì¤‘ë™ì </span><span class="text-2xl" aria-hidden="true">ğŸ¬</span>
        </button>
      </div>
    </section>

    <!-- ìœ í˜• ì„ íƒ -->
    <section id="page-type" class="bg-white rounded-b-2xl shadow-lg p-6 hidden">
      <button onclick="app.goToPage('branch')" class="back-btn mb-4" aria-label="ì§ì˜ì  ë‹¤ì‹œ ì„ íƒ">
        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>ì§ì˜ì  ë‹¤ì‹œ ì„ íƒ
      </button>
      <div class="bg-indigo-50 rounded-lg p-3 mb-4">
        <p class="text-sm text-indigo-800">ì„ íƒí•œ ì§€ì : <span id="selected-branch-name" class="font-semibold"></span></p>
      </div>
      <h2 class="text-xl font-semibold text-gray-800 mb-4">ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</h2>
      <div id="inquiry-types" class="space-y-3" role="list"></div>
      <button onclick="app.goToPage('branch')" class="btn-secondary w-full mt-4">ì·¨ì†Œ</button>
    </section>

    <!-- ì£¼ì°¨ ì•ˆë‚´ (ê³„ì–‘) -->
    <section id="page-parking-info-gyeyang" class="bg-white rounded-b-2xl shadow-lg p-6 hidden">
      <button onclick="app.goToPage('type')" class="back-btn mb-4" aria-label="ë’¤ë¡œê°€ê¸°">
        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>ë’¤ë¡œê°€ê¸°
      </button>
      <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-lg" role="alert">
        <div class="flex items-start">
          <span class="text-4xl mr-4" aria-hidden="true">ğŸ…¿ï¸</span>
          <div>
            <h3 class="text-xl font-bold text-blue-900 mb-3">ì¸ì²œê³„ì–‘ë³¸ì  ì£¼ì°¨ ì•ˆë‚´</h3>
            <p class="text-gray-700 text-lg leading-relaxed">ì§€í•˜ì£¼ì°¨ì¥ì´ ìˆìœ¼ë‚˜ í˜‘ì†Œí•˜ë‹ˆ ì°¸ê³ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
          </div>
        </div>
      </div>
      <div class="flex gap-3 mt-6">
        <button onclick="app.goToPage('type')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
        <button onclick="app.goToPage('branch')" class="btn-primary flex-1">ì²˜ìŒìœ¼ë¡œ</button>
      </div>
    </section>

    <!-- ì£¼ì°¨ ì•ˆë‚´ (ë°•ì´Œ) -->
    <section id="page-parking-info-bakchon" class="bg-white rounded-b-2xl shadow-lg p-6 hidden">
      <button onclick="app.goToPage('type')" class="back-btn mb-4" aria-label="ë’¤ë¡œê°€ê¸°">
        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>ë’¤ë¡œê°€ê¸°
      </button>
      <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-lg" role="alert">
        <div class="flex items-start">
          <span class="text-4xl mr-4" aria-hidden="true">ğŸ…¿ï¸</span>
          <div>
            <h3 class="text-xl font-bold text-blue-900 mb-3">ì¸ì²œë°•ì´Œì—­ì  ì£¼ì°¨ ì•ˆë‚´</h3>
            <p class="text-gray-700 text-lg leading-relaxed">ë’·í¸ì— ì£¼ì°¨ì¥ì´ ìˆìœ¼ë‚˜ í˜‘ì†Œí•˜ë‹ˆ ì°¸ê³ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
          </div>
        </div>
      </div>
      <div class="flex gap-3 mt-6">
        <button onclick="app.goToPage('type')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
        <button onclick="app.goToPage('branch')" class="btn-primary flex-1">ì²˜ìŒìœ¼ë¡œ</button>
      </div>
    </section>

    <!-- ì£¼ì°¨ ì•ˆë‚´ (ë¶€í‰) -->
    <section id="page-parking-info-bupyeong" class="bg-white rounded-b-2xl shadow-lg p-6 hidden">
      <button onclick="app.goToPage('type')" class="back-btn mb-4" aria-label="ë’¤ë¡œê°€ê¸°">
        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>ë’¤ë¡œê°€ê¸°
      </button>
      <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-lg" role="alert">
        <div class="flex items-start">
          <span class="text-4xl mr-4" aria-hidden="true">ğŸ…¿ï¸</span>
          <div>
            <h3 class="text-xl font-bold text-blue-900 mb-3">ë¶€í‰ì‚¼ì‚°ì  ì£¼ì°¨ ì•ˆë‚´</h3>
            <p class="text-gray-700 text-lg leading-relaxed">ì•„íŒŒíŠ¸ ìƒê°€ì— ì£¼ì°¨ê°€ ê°€ëŠ¥í•˜ì§€ë§Œ, ë¶ˆê°€í•œ ê²½ìš°ë„ ìˆìœ¼ë‹ˆ ì°¸ê³  ë°”ëë‹ˆë‹¤.</p>
          </div>
        </div>
      </div>
      <div class="flex gap-3 mt-6">
        <button onclick="app.goToPage('type')" class="btn-secondary flex-1">ì·¨ì†Œ</button>
        <button onclick="app.goToPage('branch')" class="btn-primary flex-1">ì²˜ìŒìœ¼ë¡œ</button>
      </div>
    </section>

    <!-- ë¬¸ì˜ í¼ -->
    <section id="page-form" class="bg-white rounded-b-2xl shadow-lg p-6 hidden">
      <button onclick="app.goToPage('type')" class="back-btn mb-4" aria-label="ë¬¸ì˜ ìœ í˜• ë‹¤ì‹œ ì„ íƒ">
        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>ë¬¸ì˜ ìœ í˜• ë‹¤ì‹œ ì„ íƒ
      </button>
      <div class="bg-indigo-50 rounded-lg p-3 mb-4 space-y-1">
        <p class="text-sm text-indigo-800">ì§€ì : <span id="form-branch-name" class="font-semibold"></span></p>
        <p class="text-sm text-indigo-800">ë¬¸ì˜ ìœ í˜•: <span id="form-type-name" class="font-semibold"></span></p>
      </div>
      <h2 class="text-xl font-semibold text-gray-800 mb-4">
        <span id="form-type-icon" aria-hidden="true"></span> <span id="form-type-title"></span>
      </h2>
      <form id="inquiry-form" class="space-y-4" onsubmit="event.preventDefault(); app.submitInquiry();">
        <div>
          <label for="seat-number" class="block text-sm font-medium text-gray-700 mb-2">ì¢Œì„ ë²ˆí˜¸ <span class="text-red-500">*</span></label>
          <input type="number" id="seat-number" name="seatNumber" inputmode="numeric" min="1" max="500" placeholder="ì˜ˆ: 42" class="input" required aria-required="true" aria-describedby="seat-help" />
          <p id="seat-help" class="text-xs text-gray-500 mt-1">1~500 ì‚¬ì´ ìˆ«ì</p>
        </div>
        <div>
          <label for="inquiry-content" class="block text-sm font-medium text-gray-700 mb-2">ë¬¸ì˜ ë‚´ìš© <span class="text-red-500">*</span></label>
          <textarea id="inquiry-content" name="content" rows="6" maxlength="1000" placeholder="ë¬¸ì˜í•˜ì‹¤ ë‚´ìš©ì„ ìƒì„¸íˆ ì…ë ¥í•´ì£¼ì„¸ìš” (ìµœëŒ€ 1000ì)" class="input resize-none" required aria-required="true" aria-describedby="content-help"></textarea>
          <p id="content-help" class="text-xs text-gray-500 mt-1"><span id="content-count">0</span>/1000</p>
        </div>
        <div id="live-region" class="sr-only" aria-live="polite" aria-atomic="true"></div>
        <div id="error-message" class="hidden" role="alert"></div>
        <div id="success-message" class="hidden" role="alert"></div>
        <button id="submit-button" type="submit" class="btn-primary w-full">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
          </svg>
          ë¬¸ì˜í•˜ê¸°
        </button>
        <button type="button" onclick="app.goToPage('type')" class="btn-secondary w-full">ì·¨ì†Œ</button>
      </form>

      <!-- ì§„ë‹¨ ë°°ë„ˆ (API ë¶ˆê°€ ì‹œ í‘œì‹œ) -->
      <div id="diagnostic-banner" class="hidden mt-4 text-sm text-yellow-900 bg-yellow-50 border border-yellow-200 rounded-lg p-3"></div>

      <!-- ë„ì›€ë§: í† í°/Chat ID ì–»ëŠ” ë²• -->
      <details class="mt-6">
        <summary class="text-sm text-gray-600">í…”ë ˆê·¸ë¨ í† í°/Chat ID ì–»ëŠ” ë²• (í¼ì¹˜ê¸°)</summary>
        <div class="text-sm text-gray-700 mt-2 space-y-2">
          <p>1) í…”ë ˆê·¸ë¨ì—ì„œ <b>@BotFather</b> ëŒ€í™” â†’ <code>/newbot</code> â†’ ì´ë¦„/username ì„¤ì • â†’ <b>Bot Token</b> íšë“</p>
          <p>2) <b>ê°œì¸ìœ¼ë¡œ ë°›ê¸°</b>: ë´‡ê³¼ 1:1 ì±„íŒ…ì—ì„œ â€œStartâ€ ëˆ„ë¥¸ í›„ ë¸Œë¼ìš°ì €ì—ì„œ
            <code>https://api.telegram.org/bot&lt;TOKEN&gt;/getUpdates</code> ì—´ê¸° â†’ <code>result[].message.chat.id</code> ìˆ«ì ì‚¬ìš©</p>
          <p>3) <b>ê·¸ë£¹ìœ¼ë¡œ ë°›ê¸°</b>: ë´‡ì„ ê·¸ë£¹ì— ì´ˆëŒ€í•˜ê³  ì•„ë¬´ ë©”ì‹œì§€ ì „ì†¡ â†’ ìœ„ ì£¼ì†Œë¡œ í™•ì¸ â†’ <code>chat.id = -100...</code> í˜•íƒœ ì‚¬ìš©</p>
          <p>4) Vercel â†’ í”„ë¡œì íŠ¸ â†’ Settings â†’ <b>Environment Variables</b>ì—
            <code>TELEGRAM_BOT_TOKEN</code>, <code>TELEGRAM_CHAT_ID</code> ë“±ë¡ í›„ <b>Redeploy</b></p>
        </div>
      </details>
    </section>

    <!-- í‘¸í„° -->
    <footer class="text-center mt-6 text-gray-600 text-sm">
      <p>ë¬¸ì˜í•˜ì‹  ë‚´ìš©ì€ ì‹¤ì‹œê°„ìœ¼ë¡œ ê´€ë¦¬ìì—ê²Œ ì „ë‹¬ë©ë‹ˆë‹¤</p>
      <p class="mt-1">ë¹ ë¥¸ ì‹œì¼ ë‚´ì— ë‹µë³€ë“œë¦¬ê² ìŠµë‹ˆë‹¤ ğŸ˜Š</p>
    </footer>
  </div>

  <!-- ===== API ìœ í‹¸ (ë°ëª¨ í´ë°± í¬í•¨) ===== -->
  <script>
  const API = (() => {
    const isLocal = ['localhost','127.0.0.1'].includes(location.hostname);
    const isFile = location.protocol === 'file:';
    const isPages = /github\.io$/.test(location.hostname);
    // ê°™ì€ ë„ë©”ì¸ì— APIê°€ ìˆì„ ë•ŒëŠ” ë¹ˆ ë¬¸ìì—´ ìœ ì§€. ë³„ë„ ë„ë©”ì¸ì´ë©´ ì•„ë˜ BASEë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.
    const BASE = '';

    function allowDemo(){
      // ë¡œì»¬/íŒŒì¼/ê¹ƒí—ˆë¸ŒPages í™˜ê²½ì—ì„  APIê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë°ëª¨ í—ˆìš©
      return isLocal || isFile || isPages;
    }

    async function post(path, body, opts = {}){
      const { timeout = 10000, captchaToken } = opts;
      const ctrl = new AbortController();
      const id = setTimeout(() => ctrl.abort('timeout'), timeout);

      const headers = {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      };
      if (captchaToken) headers['X-Captcha-Token'] = captchaToken;

      try{
        const res = await fetch(`${BASE}${path}`,{
          method:'POST', headers, body: JSON.stringify(body), signal: ctrl.signal, credentials: 'same-origin'
        });
        clearTimeout(id);
        let data = null; try{ data = await res.json(); }catch(_){ }
        if(!res.ok){ const msg = data?.message || `ì„œë²„ ì˜¤ë¥˜ (${res.status})`; const err = new Error(msg); err.status = res.status; err.payload = data; throw err; }
        return data;
      }catch(err){
        clearTimeout(id);
        // ë„¤íŠ¸ì›Œí¬/ì ‘ê·¼ ë¶ˆê°€ ì‹œ ë°ëª¨ ëª¨ë“œ
        if (allowDemo()) {
          console.warn('API unreachable, falling back to DEMO mode. Error:', err);
          return { ok: true, _demo: true };
        }
        throw err;
      }
    }

    // ë…¸ì¶œ: í…ŒìŠ¤íŠ¸ í—¬í¼ í¬í•¨
    return { post, isLocal, __test:{ allowDemo } };
  })();
  </script>

  <!-- ===== ì•± ì½”ë“œ ===== -->
  <script>
  const app = (() => {
    const CSS = {
      primary: 'w-full p-4 bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white rounded-xl shadow-md transition-all transform hover:scale-105 flex items-center justify-between focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2',
      btnPrimary: 'btn-primary bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2',
      btnSecondary: 'btn-secondary bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-lg shadow-md transition-all focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2',
      backBtn: 'back-btn flex items-center text-indigo-600 hover:text-indigo-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded',
      input: 'input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all',
      alertErr: 'bg-red-50 border border-red-200 rounded-lg p-3 flex items-center text-red-700',
      alertOk: 'bg-green-50 border border-green-200 rounded-lg p-3 flex items-center text-green-700'
    };

    const TYPES = [
      { id: 'room', title: 'ìŠ¤í„°ë””ë£¸ ì˜ˆì•½', icon: 'ğŸ“…' },
      { id: 'report', title: 'í•™ìŠµ ë°©í•´ í–‰ìœ„ ì‹ ê³ ', icon: 'ğŸš¨' },
      { id: 'parking', title: 'ì£¼ì°¨ ë¬¸ì˜', icon: 'ğŸš—', excludeBranches: ['bupyeong','gyeyang','bakchon'] },
      { id: 'parking_info_gyeyang', title: 'ì£¼ì°¨ ì•ˆë‚´', icon: 'ğŸ…¿ï¸', onlyBranches: ['gyeyang'], isInfo: true, infoPage: 'parking-info-gyeyang' },
      { id: 'parking_info_bakchon', title: 'ì£¼ì°¨ ì•ˆë‚´', icon: 'ğŸ…¿ï¸', onlyBranches: ['bakchon'], isInfo: true, infoPage: 'parking-info-bakchon' },
      { id: 'parking_info_bupyeong', title: 'ì£¼ì°¨ ì•ˆë‚´', icon: 'ğŸ…¿ï¸', onlyBranches: ['bupyeong'], isInfo: true, infoPage: 'parking-info-bupyeong' },
      { id: 'temperature', title: 'ì˜¨ë„ ì¡°ì ˆ ë¬¸ì˜', icon: 'ğŸŒ¡ï¸' },
      { id: 'other', title: 'ê·¸ ì™¸ ê¸°íƒ€ ë¬¸ì˜', icon: 'ğŸ’¬' }
    ];

    const state = { selectedBranch: '', selectedBranchName: '', selectedType: '', selectedTypeName: '', selectedTypeIcon: '', isSubmitting: false };

    const el = { pages:{}, form:{ seat:null, content:null, count:null, btn:null }, msg:{ err:null, errText:null, ok:null, live:null }, diag:null };

    function init(){ cache(); style(); listen(); maybeShowDiagnostics(); }

    function cache(){
      el.pages = {
        branch: document.getElementById('page-branch'),
        type: document.getElementById('page-type'),
        form: document.getElementById('page-form'),
        parkingInfoGyeyang: document.getElementById('page-parking-info-gyeyang'),
        parkingInfoBakchon: document.getElementById('page-parking-info-bakchon'),
        parkingInfoBupyeong: document.getElementById('page-parking-info-bupyeong')
      };
      el.form = {
        seat: document.getElementById('seat-number'),
        content: document.getElementById('inquiry-content'),
        count: document.getElementById('content-count'),
        btn: document.getElementById('submit-button')
      };
      el.msg = {
        err: document.getElementById('error-message'),
        errText: document.getElementById('error-text') || (()=>{
          const s=document.createElement('span'); s.id='error-text';
          el.msg.err?.appendChild(s); return s;
        })(),
        ok: document.getElementById('success-message'),
        live: document.getElementById('live-region')
      };
      el.diag = document.getElementById('diagnostic-banner');
    }

    function style(){
      document.querySelectorAll('.branch-btn').forEach(b=> b.className = CSS.primary);
      document.querySelectorAll('.btn-primary').forEach(b=> b.className = CSS.btnPrimary);
      document.querySelectorAll('.btn-secondary').forEach(b=> b.className = CSS.btnSecondary);
      document.querySelectorAll('.back-btn').forEach(b=> b.className = CSS.backBtn);
      document.querySelectorAll('.input').forEach(i=> i.className = CSS.input);
      if(el.msg.err) el.msg.err.className = CSS.alertErr + ' hidden';
      if(el.msg.ok) el.msg.ok.className   = CSS.alertOk  + ' hidden';
    }

    function listen(){
      if(el.form.content) el.form.content.addEventListener('input', updateCounter);
      document.addEventListener('keydown', (e)=>{
        if(e.key==='Escape'){
          const p = currentPage();
          if(p==='type') goToPage('branch');
          else if(['form','parkingInfoGyeyang','parkingInfoBakchon','parkingInfoBupyeong'].includes(p)) goToPage('type');
        }
      });
    }

    function maybeShowDiagnostics(){
      const url = new URL(location.href);
      if (url.searchParams.get('debug') === '1' && el.diag) {
        el.diag.classList.remove('hidden');
        el.diag.innerHTML = `ğŸ”§ ì§„ë‹¨ ëª¨ë“œ: API ì—°ê²° í™•ì¸ ì¤‘...<br>
          host=<b>${location.host}</b>, isLocal=${API.isLocal}, file=${location.protocol==='file:'}, pages=${/github\\.io$/.test(location.hostname)}<br>
          API_BASE=''`;
      }
    }

    function currentPage(){ for(const [k,v] of Object.entries(el.pages)){ if(v && !v.classList.contains('hidden')) return k; } return null; }

    function goToPage(page){
      Object.values(el.pages).forEach(x=> x?.classList.add('hidden'));
      if(page==='branch'){ el.pages.branch?.classList.remove('hidden'); resetState(); }
      else if(page==='type'){ el.pages.type?.classList.remove('hidden'); resetForm(); }
      else if(page==='form'){ el.pages.form?.classList.remove('hidden'); setTimeout(()=> el.form.seat?.focus(), 100); }
      else if(page==='parking-info-gyeyang'){ el.pages.parkingInfoGyeyang?.classList.remove('hidden'); }
      else if(page==='parking-info-bakchon'){ el.pages.parkingInfoBakchon?.classList.remove('hidden'); }
      else if(page==='parking-info-bupyeong'){ el.pages.parkingInfoBupyeong?.classList.remove('hidden'); }
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetState(){ state.selectedBranch=''; state.selectedBranchName=''; state.selectedType=''; state.selectedTypeName=''; state.selectedTypeIcon=''; }

    function resetForm(){
      if(el.form.seat) el.form.seat.value='';
      if(el.form.content){ el.form.content.value=''; updateCounter(); }
      hide(el.msg.err); hide(el.msg.ok);
    }

    function selectBranch(id, name, icon){
      state.selectedBranch=id; state.selectedBranchName=name;
      const n = document.getElementById('selected-branch-name'); if(n) n.textContent = name;
      renderTypes(id); goToPage('type');
    }

    function renderTypes(branchId){
      const c = document.getElementById('inquiry-types'); if(!c) return;
      c.innerHTML='';
      TYPES.forEach(t=>{
        if(t.excludeBranches?.includes(branchId)) return;
        if(t.onlyBranches && !t.onlyBranches.includes(branchId)) return;
        const b=document.createElement('button');
        b.className=CSS.primary; b.type='button'; b.setAttribute('role','listitem'); b.setAttribute('aria-label', t.title);
        b.innerHTML = `<span class="text-lg font-medium">${t.title}</span><span class="text-2xl" aria-hidden="true">${t.icon}</span>`;
        b.onclick = t.isInfo ? ()=> goToPage(t.infoPage) : ()=> selectType(t.id, t.title, t.icon);
        c.appendChild(b);
      });
    }

    function selectType(id,title,icon){
      state.selectedType=id; state.selectedTypeName=title; state.selectedTypeIcon=icon;
      document.getElementById('form-branch-name').textContent = state.selectedBranchName;
      document.getElementById('form-type-name').textContent = title;
      document.getElementById('form-type-icon').textContent = icon;
      document.getElementById('form-type-title').textContent = title;
      goToPage('form');
    }

    function updateCounter(){ if(el.form.content && el.form.count) el.form.count.textContent = el.form.content.value.length; }

    function show(x,msg){
      if(!x) return; x.classList.remove('hidden');
      if(msg && x===el.msg.err && el.msg.errText) el.msg.errText.textContent = msg;
      if(el.msg.live) el.msg.live.textContent = x===el.msg.err ? `ì˜¤ë¥˜: ${msg||'ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}` : 'ë¬¸ì˜ê°€ ì„±ê³µì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.';
    }
    function hide(x){ if(x) x.classList.add('hidden'); }

    function validate(seat, content){
      if(!Number.isInteger(seat) || seat<1 || seat>500) return {ok:false, msg:'ì¢Œì„ ë²ˆí˜¸ëŠ” 1~500 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.', field:'seat'};
      if(content.length<5) return {ok:false, msg:'ë¬¸ì˜ ë‚´ìš©ì€ ìµœì†Œ 5ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.', field:'content'};
      if(content.length>1000) return {ok:false, msg:'ë¬¸ì˜ ë‚´ìš©ì€ ìµœëŒ€ 1000ìê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.', field:'content'};
      return {ok:true};
    }

    async function submitInquiry(){
      if(state.isSubmitting) return;
      hide(el.msg.err); hide(el.msg.ok);

      const seat = Number(el.form.seat?.value);
      const content = el.form.content?.value.trim() || '';
      const v = validate(seat, content);
      if(!v.ok){ show(el.msg.err, v.msg); (v.field==='seat'?el.form.seat:el.form.content)?.focus(); return; }

      state.isSubmitting = true;
      const original = el.form.btn.innerHTML;
      el.form.btn.disabled = true;
      el.form.btn.innerHTML = '<span class="inline-block animate-spin mr-2">â³</span>ì „ì†¡ ì¤‘...';

      const payload = {
        branchId: state.selectedBranch,
        branchName: state.selectedBranchName,
        typeId: state.selectedType,
        typeName: state.selectedTypeName,
        typeIcon: state.selectedTypeIcon,
        seatNumber: seat,
        content,
        timestamp: new Date().toISOString()
      };

      try{
        const result = await API.post('/api/inquiry', payload, { timeout: 12000 });
        if (result && result._demo && document.getElementById('diagnostic-banner')) {
          const b = document.getElementById('diagnostic-banner');
          b.classList.remove('hidden');
          b.innerHTML = 'âš ï¸ í˜„ì¬ í™˜ê²½ì—ì„œ APIì— ì ‘ì†í•  ìˆ˜ ì—†ì–´ <b>ë°ëª¨ ëª¨ë“œ</b>ë¡œ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤. ì‹¤ì œ ì „ì†¡ì„ ì›í•˜ì‹œë©´ ë°±ì—”ë“œë¥¼ ë°°í¬í•˜ê³  API ê²½ë¡œë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”.';
        }
        show(el.msg.ok); setTimeout(()=> goToPage('branch'), 1500);
      }catch(e){
        console.error('âŒ /api/inquiry ì‹¤íŒ¨:', e);
        show(el.msg.err, e.message || 'ë¬¸ì˜ ì ‘ìˆ˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }finally{
        state.isSubmitting=false;
        el.form.btn.disabled=false;
        el.form.btn.innerHTML=original;
      }
    }

    // ê°„ë‹¨ í…ŒìŠ¤íŠ¸ (URLì— ?debug=1 ë¶™ì´ë©´ ì‹¤í–‰)
    function runTests(){
      const cases = [
        { name:'seat too small', seat:0, content:'hello world', want:false },
        { name:'seat ok, content too short', seat:10, content:'hey', want:false },
        { name:'seat ok, content max ok', seat:500, content:'x'.repeat(1000), want:true },
        { name:'seat ok, content ok', seat:1, content:'ë¬¸ì˜ë‚´ìš© ì¶©ë¶„', want:true },
      ];
      console.group('%c[TEST] validate()', 'color:#6b21a8');
      cases.forEach(tc=>{ const got = validate(tc.seat, tc.content).ok; console.assert(got===tc.want, tc.name, {got, want:tc.want}); });
      console.groupEnd();

      console.group('%c[TEST] allowDemo()', 'color:#6b21a8');
      console.assert(API.__test.allowDemo('localhost')===true, 'localhost allowed');
      console.assert(API.__test.allowDemo('127.0.0.1')===true, '127.0.0.1 allowed');
      console.groupEnd();

      console.info('%cí…ŒìŠ¤íŠ¸ ì™„ë£Œ. ì‹¤íŒ¨ í•­ëª©ì´ ë³´ì¸ë‹¤ë©´ ë©”ì‹œì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”.', 'color:#065f46');
    }

    return { init, goToPage, selectBranch, selectType, submitInquiry, runTests };
  })();

  // ì´ˆê¸°í™”
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', app.init); else app.init();

  // ìë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (?debug=1)
  (function(){ try{ if(new URL(location.href).searchParams.get('debug')==='1'){ app.runTests(); } }catch(e){} })();
  </script>
</body>
</html>

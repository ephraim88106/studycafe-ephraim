import React, { useState } from 'react';
import { Send, ArrowLeft, AlertCircle } from 'lucide-react';

export default function StudyCafeInquiry() {
  const [page, setPage] = useState('branch');
  const [selectedBranch, setSelectedBranch] = useState('');
  const [selectedType, setSelectedType] = useState('');
  const [seatNumber, setSeatNumber] = useState('');
  const [inquiryContent, setInquiryContent] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitStatus, setSubmitStatus] = useState('');

  const TELEGRAM_BOT_TOKEN = '8275814150:AAGiFsnueB7RaomovPkd_CXI63XhiQUkV9k';
  const TELEGRAM_CHAT_ID = '6192728624';

  const branches = [
    { id: 'gyeyang', name: '인천계양본점', icon: '🏢' },
    { id: 'bakchon', name: '인천박촌역점', icon: '🚇' },
    { id: 'bupyeong', name: '부평삼산점', icon: '🏙️' },
    { id: 'sangdong', name: '부천상동점', icon: '🏪' },
    { id: 'sinjung', name: '부천신중동점', icon: '🏬' }
  ];

  const inquiryTypes = [
    { id: 'room', title: '스터디룸 예약', icon: '📅' },
    { id: 'report', title: '학습 방해 행위 신고', icon: '🚨' },
    { id: 'parking', title: '주차 문의', icon: '🚗', excludeFor: ['bupyeong'] },
    { id: 'parking_info', title: '주차 안내', icon: '🅿️', onlyFor: ['bupyeong'], isInfo: true },
    { id: 'temperature', title: '온도 조절 문의', icon: '🌡️' },
    { id: 'other', title: '그 외 기타 문의', icon: '💬' }
  ];

  const getAvailableInquiryTypes = () => {
    return inquiryTypes.filter(type => {
      if (type.excludeFor && type.excludeFor.includes(selectedBranch)) {
        return false;
      }
      if (type.onlyFor) {
        return type.onlyFor.includes(selectedBranch);
      }
      return true;
    });
  };

  const handleBranchSelect = (branch) => {
    setSelectedBranch(branch);
    setPage('type');
  };

  const handleTypeSelect = (type) => {
    const selectedTypeInfo = inquiryTypes.find(t => t.id === type);
    if (selectedTypeInfo?.isInfo) {
      setPage('parking-info');
    } else {
      setSelectedType(type);
      setPage('form');
    }
  };

  const handleSubmit = async () => {
    if (!seatNumber || !inquiryContent) {
      setSubmitStatus('error');
      return;
    }

    setIsSubmitting(true);
    setSubmitStatus('');

    const selectedBranchInfo = branches.find(b => b.id === selectedBranch);
    const selectedTypeInfo = inquiryTypes.find(t => t.id === selectedType);
    const message = `🏢 에브라임 스터디카페 문의

📍 지점: ${selectedBranchInfo.icon} ${selectedBranchInfo.name}
📋 문의 유형: ${selectedTypeInfo.icon} ${selectedTypeInfo.title}
💺 좌석 번호: ${seatNumber}번
📝 문의 내용:
${inquiryContent}

⏰ 접수 시간: ${new Date().toLocaleString('ko-KR')}`;

    try {
      const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          chat_id: TELEGRAM_CHAT_ID,
          text: message
        })
      });

      if (response.ok) {
        setSubmitStatus('success');
        setTimeout(() => {
          setSeatNumber('');
          setInquiryContent('');
          setSelectedBranch('');
          setSelectedType('');
          setPage('branch');
          setSubmitStatus('');
        }, 2000);
      } else {
        setSubmitStatus('error');
      }
    } catch (error) {
      console.error('Error:', error);
      setSubmitStatus('error');
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleBackToBranch = () => {
    setPage('branch');
    setSelectedBranch('');
    setSelectedType('');
    setSeatNumber('');
    setInquiryContent('');
    setSubmitStatus('');
  };

  const handleBackToType = () => {
    setPage('type');
    setSeatNumber('');
    setInquiryContent('');
    setSubmitStatus('');
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
      <div className="max-w-2xl mx-auto">
        
        <div className="bg-white rounded-t-2xl shadow-lg p-6 mt-8">
          <h1 className="text-3xl font-bold text-center text-indigo-900">
            에브라임 스터디카페
          </h1>
          <p className="text-center text-gray-600 mt-2">직영점 문의 시스템</p>
        </div>

        {page === 'branch' && (
          <div className="bg-white rounded-b-2xl shadow-lg p-6">
            <h2 className="text-xl font-semibold text-gray-800 mb-4">
              직영점을 선택해주세요
            </h2>
            <div className="space-y-3">
              {branches.map((branch) => (
                <button
                  key={branch.id}
                  onClick={() => handleBranchSelect(branch.id)}
                  className="w-full p-4 bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white rounded-xl shadow-md transition-all transform hover:scale-105 flex items-center justify-between"
                >
                  <span className="text-lg font-medium">{branch.name}</span>
                  <span className="text-2xl">{branch.icon}</span>
                </button>
              ))}
            </div>
          </div>
        )}

        {page === 'type' && (
          <div className="bg-white rounded-b-2xl shadow-lg p-6">
            <button
              onClick={handleBackToBranch}
              className="flex items-center text-indigo-600 hover:text-indigo-800 mb-4"
            >
              <ArrowLeft size={20} className="mr-1" />
              직영점 다시 선택
            </button>

            <div className="bg-indigo-50 rounded-lg p-3 mb-4">
              <p className="text-sm text-indigo-800">
                선택한 지점: <span className="font-semibold">
                  {branches.find(b => b.id === selectedBranch)?.name}
                </span>
              </p>
            </div>

            <h2 className="text-xl font-semibold text-gray-800 mb-4">
              무엇을 도와드릴까요?
            </h2>
            <div className="space-y-3">
              {getAvailableInquiryTypes().map((type) => (
                <button
                  key={type.id}
                  onClick={() => handleTypeSelect(type.id)}
                  className="w-full p-4 bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white rounded-xl shadow-md transition-all transform hover:scale-105 flex items-center justify-between"
                >
                  <span className="text-lg font-medium">{type.title}</span>
                  <span className="text-2xl">{type.icon}</span>
                </button>
              ))}
            </div>
            <button
              onClick={handleBackToBranch}
              className="w-full mt-4 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-lg shadow-md transition-all"
            >
              취소
            </button>
          </div>
        )}

        {page === 'parking-info' && (
          <div className="bg-white rounded-b-2xl shadow-lg p-6">
            <button
              onClick={handleBackToType}
              className="flex items-center text-indigo-600 hover:text-indigo-800 mb-4"
            >
              <ArrowLeft size={20} className="mr-1" />
              뒤로가기
            </button>
            <div className="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-lg">
              <div className="flex items-start">
                <span className="text-4xl mr-4">🅿️</span>
                <div>
                  <h3 className="text-xl font-bold text-blue-900 mb-3">부평삼산점 주차 안내</h3>
                  <p className="text-gray-700 text-lg leading-relaxed">
                    아파트 상가에 주차가 가능하지만, 안되는 경우도 있으니 참고해주시기 바랍니다.
                  </p>
                </div>
              </div>
            </div>
            <div className="flex gap-3 mt-6">
              <button
                onClick={handleBackToType}
                className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-lg shadow-md transition-all"
              >
                취소
              </button>
              <button
                onClick={handleBackToBranch}
                className="flex-1 bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all"
              >
                처음으로
              </button>
            </div>
          </div>
        )}

        {page === 'form' && (
          <div className="bg-white rounded-b-2xl shadow-lg p-6">
            <button
              onClick={handleBackToType}
              className="flex items-center text-indigo-600 hover:text-indigo-800 mb-4"
            >
              <ArrowLeft size={20} className="mr-1" />
              문의 유형 다시 선택
            </button>

            <div className="bg-indigo-50 rounded-lg p-3 mb-4 space-y-1">
              <p className="text-sm text-indigo-800">
                지점: <span className="font-semibold">
                  {branches.find(b => b.id === selectedBranch)?.name}
                </span>
              </p>
              <p className="text-sm text-indigo-800">
                문의 유형: <span className="font-semibold">
                  {inquiryTypes.find(t => t.id === selectedType)?.title}
                </span>
              </p>
            </div>

            <h2 className="text-xl font-semibold text-gray-800 mb-4">
              {inquiryTypes.find(t => t.id === selectedType)?.icon}{' '}
              {inquiryTypes.find(t => t.id === selectedType)?.title}
            </h2>

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  좌석 번호
                </label>
                <input
                  type="text"
                  value={seatNumber}
                  onChange={(e) => setSeatNumber(e.target.value)}
                  placeholder="예: 42"
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  문의 내용
                </label>
                <textarea
                  value={inquiryContent}
                  onChange={(e) => setInquiryContent(e.target.value)}
                  placeholder="문의하실 내용을 상세히 입력해주세요"
                  rows="6"
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"
                />
              </div>

              {submitStatus === 'error' && (
                <div className="bg-red-50 border border-red-200 rounded-lg p-3 flex items-center text-red-700">
                  <AlertCircle size={20} className="mr-2" />
                  <span>문의 접수에 실패했습니다. 다시 시도해주세요.</span>
                </div>
              )}

              {submitStatus === 'success' && (
                <div className="bg-green-50 border border-green-200 rounded-lg p-3 flex items-center text-green-700">
                  <span>✅ 문의가 성공적으로 접수되었습니다!</span>
                </div>
              )}

              <button
                onClick={handleSubmit}
                disabled={isSubmitting}
                className="w-full bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {isSubmitting ? (
                  '전송 중...'
                ) : (
                  <>
                    <Send size={20} className="mr-2" />
                    문의하기
                  </>
                )}
              </button>

              <button
                onClick={handleBackToType}
                className="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-lg shadow-md transition-all"
              >
                취소
              </button>
            </div>
          </div>
        )}

        <div className="text-center mt-6 text-gray-600 text-sm">
          <p>문의하신 내용은 실시간으로 관리자에게 전달됩니다</p>
          <p className="mt-1">빠른 시일 내에 답변드리겠습니다 😊</p>
        </div>
      </div>
    </div>
  );
}
